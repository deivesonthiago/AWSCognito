ServiÃ§os AWS neste projeto
COGNITO: Fornece autenticaÃ§Ã£o, autorizaÃ§Ã£o e gerenciamento de usuÃ¡rios para suas aplicaÃ§Ãµes Web e mÃ³veis. Seus usuÃ¡rios podem fazer login diretamente com um nome de usuÃ¡rio e uma senha ou por meio de terceiros, como o Facebook, a Amazon, o Google ou a Apple. Saiba mais.
API GATEWAY: ServiÃ§o gerenciado que permite criaÃ§Ã£o, publicaÃ§Ã£o, manutenÃ§Ã£o, monitoramento e proteÃ§Ã£o de APIs REST e WebSocket em qualquer escala. Saiba mais.
LAMBDA: ServiÃ§o de computaÃ§Ã£o sem servidor e orientado a eventos que permite executar cÃ³digo para praticamente qualquer tipo de aplicaÃ§Ã£o ou serviÃ§o de backend sem provisionar ou gerenciar servidores. Saiba mais.
DYNAMODB: Banco de dados de chave-valor NoSQL, sem servidor e totalmente gerenciado, projetado para executar aplicaÃ§Ãµes de alta performance em qualquer escala. Saiba mais.
ğŸ“„ DescriÃ§Ã£o do desafio de projeto
Oferecer autenticaÃ§Ã£o, autorizaÃ§Ã£o e gerenciamento de usuÃ¡rios para suas aplicaÃ§Ãµes Web e Mobile com o Amazon Cognito. Esse serviÃ§o, totalmente gerenciado pela AWS, suporta os principais mecanismos de seguranÃ§a do mercado, alÃ©m da integraÃ§Ã£o com terceiros, como Facebook, Google, Apple ou a prÃ³pria Amazon.

ğŸ’» MÃ£o no console
Todas as etapas deste projeto foram feitas diretamente no AWS Management Console.

Todos os nomes marcados como cÃ³digo foram dados por mim e, portanto, ficam a critÃ©rio de quem estiver reproduzindo o projeto.

1. Criando uma API REST no API Gateway
Entrar na tela do API Gateway e clicar em ğŸ‘‰ Create API
Em Choose an API type â¡ï¸ REST API â¡ï¸ Build
Em Choose the protocol marque REST e em Create new API selecione New API
No campo API name inserir lab-cognito-apiğŸ‘‰ Next
Em Endpoint Type selecione Regional ğŸ‘‰ Create API
Na tela de resources clique em Actions â¡ï¸ Create Resource â¡ï¸ Resource name: items ğŸ‘‰ Create resource
â— O mÃ©todo para este recurso serÃ¡ criado mais adiante.

2. Criando a tabela no DynamoDB
Na tela principal do serviÃ§o clicar em ğŸ‘‰ Create Table
Em Table name inserir lab-cognito-table
Em Partition key inserir a chave id e deixar o tipo string
Rolar a pÃ¡gina atÃ© o final e clicar em ğŸ‘‰ Create table
3. Criando funÃ§Ã£o Lambda
Dentro do console do Lambda clicar em ğŸ‘‰ Create function
Deixar selecionada a opÃ§Ã£o Author from scratch para criar uma funÃ§Ã£o do zero
Em Function name inserir lab-cognito-putItemFunction
Em Runtime selecionar Node.js na versÃ£o de sua preferÃªncia
Deixar a opÃ§Ã£o Architecture em x86_64 ğŸ‘‰ Create function
No editor de cÃ³digo abaixo de Code source inserir o conteÃºdo de putItemFunction.js que estÃ¡ neste repositÃ³rio
Depois de colar o cÃ³digo da funÃ§Ã£o clicar em ğŸ‘‰ Deploy
â— Caso utilize o arquivo putItemFunction.js deste repositÃ³rio nÃ£o esqueÃ§a verificar se precisa ajustar o nome da tabela.

Dentro do recurso criado serÃ¡ necessÃ¡rio configurar o IAM para que possa interagir com a tabela criada no DynamoDB.

Clicar em Configuration â¡ï¸ Permissions e abrir o link da Role name
Na tela do IAM que abrirÃ¡ em outra aba, dentro de Permissions clicar em Add inline policy
Em Visual editor selecione Service
Na caixa de pesquisa digite dynamodb e selecione o serviÃ§o
Na caixa de pesquisa de Actions digite a aÃ§Ã£o putitem e marque a caixa permitindo a aÃ§Ã£o
Logo abaixo em Resources deixe marcado Specific e clique em Add ARN
Na tela que abirÃ¡ em pop-up insira o ARN da tabela criada anteriormente no DynamoDB â¡ï¸ Add â¡ï¸ Review policy inserir nome putitem-policy ğŸ‘‰Create policy
â— ARN (Amazon Resource Name) Ã© um identificador Ãºnico de cada recurso criado na AWS.

Agora a funÃ§Ã£o Lambda conseguirÃ¡ interagir com o banco de dados mas sÃ³ com a funÃ§Ã£o de inserÃ§Ã£o de items (put item).

4. Integrando o API Gateway com o Lambda
Voltando a tela do API Gateway entre na API criada anteriormente â¡ï¸ Resources â¡ï¸ /items â¡ï¸ Actions â¡ï¸ Create Method â¡ï¸ POST â¡ï¸ e confirma â˜‘ï¸ Dentro do mÃ©todo defina os seguintes parÃ¢metros:
Integration type ğŸ”˜ Lambda Function
Use Lambda Proxy integration âœ… (Muito importante, nÃ£o esquecer de marcar)
Lambda Region us-east-1 (Defina a mesma regiÃ£o que utilizou nos outros recursos)
Lambda Function lab-cognito-putItemFunction (O nome da funÃ§Ã£o Lambda)
Use Default Timeout âœ…
â¡ï¸ Save â¡ï¸ OK
Seleciona o mÃ©todo POST â¡ï¸ Actions ğŸ‘‰ Deploy API â¡ï¸
Deployment stage [New Stage] â¡ï¸ Stage name* dev ğŸ‘‰ Deploy
5. Teste no Postman
Add Request â¡ï¸ Method POST â¡ï¸ Inserir o endpoint gerado no API Gateway

Body â¡ï¸ Raw â¡ï¸ JSON â¡ï¸ Adicionar o seguinte body
{ "id": "005", "price": 165, "prod": "CÃ¢mera Tekpix" }

ğŸ‘‰ Send

ApÃ³s o teste esses dados devem aparecer na tabela do DynamoDB.

6. Criando user pool e configurando atributos no Amazon Cognito
A maior parte das configuraÃ§Ãµes envolvendo polÃ­tica de seguranÃ§a podem variar de acordo com a necessidade e o gosto de quem estÃ¡ configurando. Os meus parÃ¢metros foram os seguintes:

Na tela inicial do Cognito ğŸ‘‰ Create user pool
Step 1 of 6: Configure sign-in experience
Authentication providers ğŸ‘‰ â˜‘ï¸ Cognito user pool
Cognito user pool sign-in options âœ… Email ğŸ‘‰ Next
Step 2 of 6: Configure security requirements
Password policy ğŸ‘‰ ğŸ”˜ Custom
Password minimum length 8
 Contains at least 1 number
 Contains at least 1 special character
 Contains at least 1 uppercase letter
 Contains at least 1 lowercase letter
Multi-factor authentication ğŸ‘‰ ğŸ”˜ No MFA
User account recovery ğŸ‘‰ â˜‘ï¸ Enable self-service account recovery - Recommended
Delivery method for user account recovery messages ğŸ‘‰ ğŸ”˜ Email only ğŸ‘‰ Next
Step 3 of 6: Configure sign-up experience
Self-service sign-up ğŸ‘‰ â˜‘ï¸ Enable self-registration
Cognito-assisted verification and confirmation ğŸ‘‰ â˜‘ï¸ Allow Cognito to automatically send messages to verify and confirm - Recommended
Attributes to verify ğŸ‘‰ ğŸ”˜ Send email message, verify email address
Verifying attribute changes ğŸ‘‰ â˜‘ï¸ Keep original attribute value active when an update is pending - Recommended
Active attribute values when an update is pending ğŸ‘‰ ğŸ”˜ Email address
ğŸ‘‰ Next
Step 4 of 6: Configure message delivery
ğŸ‘‰ ğŸ”˜ Send email with Cognito
FROM email address no-reply@verificationemail.com
ğŸ‘‰ Next
Step 5 of 6: Integrate your app
ğŸ‘‰ User pool name lab-cognito-userPool
Hosted authentication pages ğŸ‘‰ â˜‘ï¸ Use the Cognito Hosted UI
Domain ğŸ‘‰ ğŸ”˜ Use a Cognito domain
Cognito domain https://lab-bootcamp .auth.us-east-1.amazoncognito.com
Initial app client â¡ï¸ App type ğŸ‘‰ ğŸ”˜ Public client
App client name lab-cognito-appClient
Client secret ğŸ‘‰ ğŸ”˜ Don't generate a client secret
Allowed callback URLs â¡ï¸ URL https://example.com/
Advanced app client settings (Deixarei os valores padrÃ£o, veja se sua necessidade Ã© outra)
OAuth 2.0 grant types: (marque os tipos abaixo)
 Implicit grant
 Authorization code grant
OpenID Connect scopes: (marque os valores abaixo)
 Email
 OpenID
Attribute read and write permissions:
Attribute: name â˜‘ï¸ Read â˜‘ï¸ Write
ğŸ‘‰ Next
Step 6 of 6: Review and create
ğŸ‘‰ Create user pool
7. Criando request de login no Postman
Add request â¡ï¸ Authorization â¡ï¸ Type ğŸ‘‰ â˜‘ï¸ OAuth 2.0
Configure New Token â¡ï¸ Configuration Options
Grant Type ğŸ‘‰ Implicit
Callback URL https://example.com
Auth URL https://lab-bootcamp.auth.us-east-1.amazoncognito.com/login
Client ID Cole neste campo o Client ID gerado no Cognito na tela App client information
Scope email openid
Client Authentication Send clients credentials in body
ğŸ‘‰ Get New Access Token

Vai abrir a tela de login/cadastro. Aproveite e faÃ§a um cadastro (Sign up) para testar as polÃ­ticas definidas no Cognito.
ApÃ³s cadastrar e fazer a verificaÃ§Ã£o por e-mail faÃ§a o login na conta pela mesma tela (sÃ³ que na opÃ§Ã£o Sign in).
Se der tudo certo (Your registration has been confirmed!) a tela do Postman vai exibir a mensagem Authentication complete ğŸ‘‰ Proceed
ApÃ³s clicar em prosseguir o Postman gerarÃ¡ os tokens necessÃ¡rios para interagir com uma API autenticada.
8. Atrelando user pool do Cognito com API Gateway
Agora vamos atrelar o user pool do cognito com a API criada neste projeto.

Voltando para o console do API Gateway clique na API criada anteriormente (lab-cognito-api) â¡ï¸ Authorizers â¡ï¸ Create New Authorizer
Name lab-cognito-authorizer
Type ğŸ‘‰ ğŸ”˜ Cognito
Cognito User Pool â¡ï¸ us-east-1 lab-cognito-userPool (selecione o user pool que vocÃª acabou de criar no cognito)
Token Source Authorization
ğŸ‘‰ Create
Ainda dentro de API Gateway entrar na tela Resources â¡ï¸ POST â¡ï¸ Method Request
Settings â¡ï¸ Authorization â¡ï¸ âœï¸ lab-cognito-authorizer â˜‘ï¸ (recarregue a pÃ¡gina se o autorizador nÃ£o aparecer de primeira)
ApÃ³s setar e salvar somente esta opÃ§Ã£o Ã© necessÃ¡rio fazer o deploy da API novamente em Actions â¡ï¸ Deploy API â¡ï¸ Deployment stage dev ğŸ‘‰ Deploy
9. Request de login com Token ID no Postman
Copia o Token ID gerado no teste anterior e volta no POST request (feito no item 5 deste tutorial)

VÃ¡ para o JSON e faÃ§a alguma alteraÃ§Ã£o como no exemplo abaixo

{ "id": "010", "price": 3200, "prod": "iPhone" }

Na opÃ§Ã£o Authorization â¡ï¸ Type Bearer Token â¡ï¸ Token cola o Token ID que foi copiado ğŸ‘‰ Send

Se a resposta da request for 'Item inserido com sucesso!' significa que a API aceitou a autenticaÃ§Ã£o do seu usuÃ¡rio criado no Cognito.

Para ter certeza que a API comunicou com o banco entre no DynamoDB e confira se a tabela exibe as informaÃ§Ãµes enviadas acima.

Caso todos os testes tenham ocorrido com sucesso podemos concluir que o Cognito estÃ¡ gerenciando a autenticaÃ§Ã£o e a autorizaÃ§Ã£o da nossa aplicaÃ§Ã£o. Essas sÃ£o apenas algumas funÃ§Ãµes que este serviÃ§o Ã© capaz de prover

A partir desses conceitos podemos utilizar esses recursos em projetos maiores que eventualmente possam entrar em produÃ§Ã£o.

Para entender mais a fundo leia a DocumentaÃ§Ã£o do Amazon Cognito
